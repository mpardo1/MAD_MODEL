max_t <- max(df_rho$time)
times <- seq(min_t,max_t, 1)
out <- ode(Y, times, func = "derivs",
parms = parms, dllname = "model_vec_cte",
initfunc = "initmod", nout = 1,
outnames = "Sum", initforc = "forcc",
forcings = forcs_mat, fcontrol = list(method = "constant"))
head(out)
ode_df <- merge(out, df_date, by ="time")
ode_df$Sum <- NULL
head(ode_df)
colnames(ode_df) <- c("Time", "L", "A","Ah", "date" )
saveRDS(ode_df[,c(1:4)], file = "~/MAD_MODEL/SUR_MODEL/Code/adults.rds")
scientific_10 <- function(x) {
parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}
ode_df <- ode_df  %>% filter( ode_df$date  < as.Date("2018-07-01","%Y-%m-%d"))
ggplot(ode_df)  +
geom_line(aes( date, L)) +
ylab("Counts") +
ggtitle("Larvae dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes( date, A)) +
ylab("Counts") +
ggtitle("Adult mosquito dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes( date, Ah)) +
ylab("Counts") +
ggtitle("Handling adult mosquito dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
#------------------------------------------------------------------------------#
########## WITH PARAMETERS DEPENDING on T ###########
######---------- Temperatures from Barcelona-------------#####
Path_temp = "~/MAD_MODEL/VECTOR_MODEL/data/bcn_weather_daily.Rds"
temp <-read_rds(Path_temp)
temp$date = as.Date(temp$date , "%Y-%m-%d")
temp <- temp %>%  group_by(date) %>% summarise(mean_temp = mean(valor))
min_date_temp <- min(temp$date)
max_date_temp <- max(temp$date)
ggplot(temp) +
geom_line(aes(date, mean_temp))+
ggtitle("Mean temperature Barcelona") +
xlab("Mean temperature")+
theme_bw()
#-------------------------------------------------------------------------------#
# Functional responses:
# Gonotrophic cycle (Carlos):
gonot <- function(T){
a = 0.045*T^2-2.617*T+41.105
val = min(1,1/a)
return(val)
}
# Paper "How does the dengue vector mosquito..."
d_L <- function(T){
val = 0.1727*exp(-((T-28.4)/12.82)^2)
return(val)
}
# # Larva mortality rate
delta_L <- function(T){
val = 0.021643*T^2 - 0.959568*T + 10.440131
val = max(0, val)
return(val)
}
# Adult mosquito mortality rate
delta_A <- function(T){
a = abs(-0.1921*T^2+8.147*T-22.98)
val =  min(1, 1/a)
return(val)
}
# Larva mortality rate
#Paper "How does the dengue vector mosquito..."
# delta_L <- function(T){
#   a = abs(-0.1921*T^2+8.147*T-22.98)
#   val = min(1, 1/a)
#   return(val)
# }
#-------------------------------------------------------------------------------#
######## PLOTS FUNCTIONAL RESPONSES #########
vec = seq(0,40,1)
df_gonot_vec <- data.frame(temp = vec, gonot =unlist(lapply(vec,gonot)))
df_dL_vec <- data.frame(temp = vec, dL = unlist(lapply(vec,d_L)))
df_deltaL_vec <- data.frame(temp = vec, deltaL = unlist(lapply(vec,delta_L)))
df_deltaA_vec <- data.frame(temp = vec, deltaA = unlist(lapply(vec,delta_A)))
ggplot(df_gonot_vec) + geom_line(aes(temp,gonot)) +
ggtitle("Inverse of the Gonotrophic cycle")+
theme_bw()
ggplot(df_dL_vec) + geom_line(aes(temp,dL)) +
ggtitle("Larva development rate")+
theme_bw()
ggplot(df_deltaL_vec) + geom_line(aes(temp,deltaL)) +
ggtitle("Larva mortality rate")+
theme_bw()
ggplot(df_deltaA_vec) + geom_line(aes(temp,deltaA)) +
ggtitle("Mosquito adult mortality rate")+
theme_bw()
ggplot(df_dl_opt_vec) + geom_line(aes(temp,deltaA)) +
ggtitle("Mosquito adult mortality rate")+
theme_bw()
#---------------------------------------------------------------------------#
####### PLOTS FUNCTIONAL RESPONSE TEMP BCN 2018-2021 ########
# Compute the values of the functions/forcings with temp.
# Compute the minimum date of the rho:
min_rho_date <- min(df_rho$date)
min_temp_date <- min(temp$date)
min_date <-max(min_rho_date, min_temp_date)
max_rho_date <- max(df_rho$date)
max_temp_date <- max(temp$date)
max_date <-min(max_rho_date, max_temp_date)
# DFs with the date and value of the parameter at that time.
temp <- temp  %>% filter( temp$date >= min_date & temp$date <= max_date)
df_date <- data.frame(date = temp$date)
df_date$time = as.numeric(df_date$date - as.Date(min_date,"%Y-%m-%d") , units="days")
gono = unlist(lapply(temp$mean_temp,gonot))
df_gonot_out <- data.frame(date = temp$date, gono)
df_gonot_out$time = as.numeric(df_gonot_out$date - as.Date(min_date,"%Y-%m-%d") , units="days")
df_gonot_out <- df_gonot_out %>% filter( df_gonot_out$time >= 0)
df_dL_out <- data.frame(date = temp$date, dL = unlist(lapply(temp$mean_temp,d_L)))
df_dL_out$time = as.numeric(df_dL_out$date - as.Date(min_date,"%Y-%m-%d") , units="days")
df_dL_out <- df_dL_out %>% filter( df_dL_out$time >= 0)
df_deltaL_out <- data.frame(date = temp$date, deltaL = unlist(lapply(temp$mean_temp,delta_L)))
df_deltaL_out$time = as.numeric(df_deltaL_out$date - as.Date(min_date,"%Y-%m-%d") , units="days")
df_deltaL_out <- df_deltaL_out %>% filter( df_deltaL_out$time >= 0)
df_deltaA_out <- data.frame(date = temp$date, deltaA = unlist(lapply(temp$mean_temp,delta_A)))
df_deltaA_out$time = as.numeric(df_deltaA_out$date - as.Date(min_date,"%Y-%m-%d") , units="days")
df_deltaA_out <- df_deltaA_out %>% filter( df_deltaA_out$time >= 0)
df_rho$time = as.numeric(df_rho$date - as.Date(min_date,"%Y-%m-%d") , units="days")
df_rho <- df_rho %>% filter( df_rho$time >= 0)
ggplot(df_gonot_out) +
geom_line(aes(date,gono)) +
ggtitle("Gonotrophic cycle")+
theme_bw()
ggplot(df_dL_out) +
geom_line(aes(date,dL)) +
ggtitle("Larva development rate")+
theme_bw()
ggplot(df_deltaL_out) +
geom_line(aes(date,deltaL)) +
ggtitle("Larva mortality rate")+
theme_bw()
ggplot(df_deltaA_out) +
geom_line(aes(date,deltaA)) +
ggtitle("Adult mosquito mortality rate")+
theme_bw()
#-----------------------------------------------------------------------------------------#
############ PREPARE DATA FOR DESOLVE AS FORCINGS #############
df_gonot_out$date <- NULL
df_gonot_out <- df_gonot_out[,c(2,1)]
df_dL_out$date <- NULL
df_dL_out <- df_dL_out[,c(2,1)]
df_deltaL_out$date <- NULL
df_deltaL_out <- df_deltaL_out[,c(2,1)]
df_deltaA_out$date <- NULL
df_deltaA_out <- df_deltaA_out[,c(2,1)]
df_rho$date <- NULL
df_rho <- df_rho[,c(2,1)]
#-----------------------------------------------------------------------------------------#
############# INTEGRATION NON - AUTONOMOUS ##############
Path = "~/MAD_MODEL/VECTOR_MODEL/Code/PARAM_ESTIMA/"
setwd(Path)
system("R CMD SHLIB model_vec.c")
dyn.load("model_vec.so")
f = 200
K = 250000
H = 1600000
# We create a vector with the constant parameters.
parms = c(f,K,H)
# We set the initial conditions to cero.
Y <- c(100,0,0)
# List with the data frames of the forcings, sort as the c code.
forcs_mat <- list(data.matrix(df_rho),
data.matrix(df_deltaL_out),
data.matrix(df_deltaA_out),
data.matrix(df_dL_out),
data.matrix(df_gonot_out))
min_t <- min(df_rho$time)
max_t <- max(df_rho$time)
times <- seq(min_t,max_t, 1)
out <- ode(Y, times, func = "derivs",
parms = parms, dllname = "model_vec",
initfunc = "initmod", nout = 1,
outnames = "Sum", initforc = "forcc",
forcings = forcs_mat, fcontrol = list(method = "constant"))
ode_out <- data.frame(out)
ode_df <- merge(ode_out, df_date, by ="time")
ode_df$Sum <- NULL
head(ode_df)
#-------------------------------------------------------------------------------------#
########## PLOTS RESULTS INTEGRATION ###########
colnames(ode_df) <- c("Time", "L","A","Ah", "date" )
df_L_A <- ode_df[,c(5,2,3)]
df_Ah <- ode_df[,c(5,4)]
df_L <- ode_df[,c(5,2)]
df_plot_1 <- reshape2::melt(df_L_A, id.vars = c("date"))
df_plot_L <- reshape2::melt(df_L, id.vars = c("date"))
df_plot <- reshape2::melt(df_Ah, id.vars = c("date"))
scientific_10 <- function(x) {
parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}
# ode_df <- ode_df  %>% filter( ode_df$date  < as.Date("2019-04-01","%Y-%m-%d"))
ode_df <- ode_df  %>% filter( ode_df$date  > as.Date("2018-05-15","%Y-%m-%d"))
ggplot(ode_df)  +
geom_line(aes(date, L)) +
ylab("Counts") +
ggtitle("Larvae dynamics") +
theme_bw() +
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes( date, A)) +
ylab("Counts") +
ggtitle("Adult mosquito dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10) +
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes(date, Ah)) +
ylab("Counts") +
ggtitle("Handling mosquitoes dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
# We create a vector with the constant parameters.
parms = c(fecun = f,Ka = K,Hum = H)
# We set the initial conditions to cero.
Y <- c(100,0,0)
# List with the data frames of the forcings, sort as the c code.
forcs_mat <- list(data.matrix(df_rho),
data.matrix(df_deltaL_out),
data.matrix(df_deltaA_out),
data.matrix(df_dL_out),
data.matrix(df_gonot_out))
min_t <- min(df_rho$time)
max_t <- max(df_rho$time)
times <- seq(min_t,max_t, 1)
out <- ode(Y, times, func = "derivs",
parms = parms, dllname = "model_vec",
initfunc = "initmod", nout = 1,
outnames = "Sum", initforc = "forcc",
forcings = forcs_mat, fcontrol = list(method = "constant"))
ode_out <- data.frame(out)
ode_df <- merge(ode_out, df_date, by ="time")
ode_df$Sum <- NULL
head(ode_df)
#-------------------------------------------------------------------------------------#
########## PLOTS RESULTS INTEGRATION ###########
colnames(ode_df) <- c("Time", "L","A","Ah", "date" )
df_L_A <- ode_df[,c(5,2,3)]
df_Ah <- ode_df[,c(5,4)]
df_L <- ode_df[,c(5,2)]
df_plot_1 <- reshape2::melt(df_L_A, id.vars = c("date"))
df_plot_L <- reshape2::melt(df_L, id.vars = c("date"))
df_plot <- reshape2::melt(df_Ah, id.vars = c("date"))
scientific_10 <- function(x) {
parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}
# ode_df <- ode_df  %>% filter( ode_df$date  < as.Date("2019-04-01","%Y-%m-%d"))
ode_df <- ode_df  %>% filter( ode_df$date  > as.Date("2018-05-15","%Y-%m-%d"))
ggplot(ode_df)  +
geom_line(aes(date, L)) +
ylab("Counts") +
ggtitle("Larvae dynamics") +
theme_bw() +
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes( date, A)) +
ylab("Counts") +
ggtitle("Adult mosquito dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10) +
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes(date, Ah)) +
ylab("Counts") +
ggtitle("Handling mosquitoes dynamics") +
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
#------------------------------------------------------------------------------------#
############# INTEGRATION rho CTE ##############
Path = "~/MAD_MODEL/VECTOR_MODEL/Code/PARAM_ESTIMA/"
setwd(Path)
system("R CMD SHLIB model_rho_cte.c")
dyn.load("model_rho_cte.so")
f = 200
K = 250000
H = 1600000
rho = 0.1
# We create a vector with the constant parameters.
parms = c(fecun = f, Ka = K, Hum = H, rho = rho)
# We set the initial conditions to cero.
Y <- c(100,0,0)
# List with the data frames of the forcings, sort as the c code.
forcs_mat <- list(data.matrix(df_deltaL_out),
data.matrix(df_deltaA_out),
data.matrix(df_dL_out),
data.matrix(df_gonot_out))
min_t <- min(df_rho$time)
max_t <- max(df_rho$time)
times <- seq(min_t,max_t, 1)
out <- ode(Y, times, func = "derivs",
parms = parms, dllname = "model_rho_cte",
initfunc = "initmod", nout = 1,
outnames = "Sum", initforc = "forcc",
forcings = forcs_mat, fcontrol = list(method = "constant"))
ode_out <- data.frame(out)
ode_df <- merge(ode_out, df_date, by ="time")
ode_df$Sum <- NULL
head(ode_df)
#-------------------------------------------------------------------------------------#
########## PLOTS RESULTS INTEGRATION  ###########
colnames(ode_df) <- c("Time", "L", "Ah","A", "date" )
df_L_A <- ode_df[,c(5,2,3)]
df_Ah <- ode_df[,c(5,4)]
df_L <- ode_df[,c(5,2)]
df_plot_1 <- reshape2::melt(df_L_A, id.vars = c("date"))
df_plot_L <- reshape2::melt(df_L, id.vars = c("date"))
df_plot <- reshape2::melt(df_Ah, id.vars = c("date"))
scientific_10 <- function(x) {
parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}
# ode_df <- ode_df  %>% filter( ode_df$date  < as.Date("2019-04-01","%Y-%m-%d"))
ode_df <- ode_df  %>% filter( ode_df$date  > as.Date("2018-05-15","%Y-%m-%d"))
ggplot(ode_df)  +
geom_line(aes(date, L)) +
ylab("Counts") +
ggtitle("Larvae dynamics")+
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes( date, A)) +
ylab("Counts") +
ggtitle("Adult mosquito dynamics")+
theme_bw() + scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes(date, Ah)) +
ylab("Counts") +
ggtitle("Handling mosquitoes dynamics") +
theme_bw() + scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
rho = 0.01
# We create a vector with the constant parameters.
parms = c(fecun = f, Ka = K, Hum = H, rho = rho)
# We set the initial conditions to cero.
Y <- c(100,0,0)
# List with the data frames of the forcings, sort as the c code.
forcs_mat <- list(data.matrix(df_deltaL_out),
data.matrix(df_deltaA_out),
data.matrix(df_dL_out),
data.matrix(df_gonot_out))
min_t <- min(df_rho$time)
max_t <- max(df_rho$time)
times <- seq(min_t,max_t, 1)
out <- ode(Y, times, func = "derivs",
parms = parms, dllname = "model_rho_cte",
initfunc = "initmod", nout = 1,
outnames = "Sum", initforc = "forcc",
forcings = forcs_mat, fcontrol = list(method = "constant"))
ode_out <- data.frame(out)
ode_df <- merge(ode_out, df_date, by ="time")
ode_df$Sum <- NULL
head(ode_df)
#-------------------------------------------------------------------------------------#
########## PLOTS RESULTS INTEGRATION  ###########
colnames(ode_df) <- c("Time", "L", "A","Ah", "date" )
df_L_A <- ode_df[,c(5,2,3)]
df_Ah <- ode_df[,c(5,4)]
df_L <- ode_df[,c(5,2)]
df_plot_1 <- reshape2::melt(df_L_A, id.vars = c("date"))
df_plot_L <- reshape2::melt(df_L, id.vars = c("date"))
df_plot <- reshape2::melt(df_Ah, id.vars = c("date"))
scientific_10 <- function(x) {
parse(text=gsub("e", " %*% 10^", scales::scientific_format()(x)))
}
# ode_df <- ode_df  %>% filter( ode_df$date  < as.Date("2019-04-01","%Y-%m-%d"))
ode_df <- ode_df  %>% filter( ode_df$date  > as.Date("2018-05-15","%Y-%m-%d"))
ggplot(ode_df)  +
geom_line(aes(date, L)) +
ylab("Counts") +
ggtitle("Larvae dynamics")+
theme_bw() +
# scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes( date, A)) +
ylab("Counts") +
ggtitle("Adult mosquito dynamics")+
theme_bw() + scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
ggplot(ode_df)  +
geom_line(aes(date, Ah)) +
ylab("Counts") +
ggtitle("Handling mosquitoes dynamics") +
theme_bw() + scale_y_continuous(labels = scientific_10)+
theme(text = element_text(size=18))
rm(list = ls())
library("parallel")
library("tidyverse")
library("deSolve")
library("coda")
# True param:
gam1 = 0.025
gam2 = 0.14
gam3 = 0.48
true1 = gam1
true2 = gam2
true3 = gam3
trueSD = 1
# Easy plots:
output <- load("~/Documentos/PHD/2021/SUR_Model/OUTPUT/chain_var_0_0008_sum_2000eq_3param_15000_2021-09-27.RData")
burnIn = 5000
acceptance = 1-mean(duplicated(chain[-(1:burnIn),]))
par(mfrow = c(2,4))
hist(chain[-(1:burnIn),1],nclass=30, main = expression(paste('Posterior of ', gamma[1])), xlab="True value = red line" )
abline(v = mean(chain[-(1:burnIn),1]))
abline(v = true1, col="red" )
hist(chain[-(1:burnIn),2],nclass=30, main=expression(paste('Posterior of ', gamma[2])), xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),2]))
abline(v = true2, col="red" )
hist(chain[-(1:burnIn),3],nclass=30, main=expression(paste('Posterior of ', gamma[3])), xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),3]))#
abline(v = true3, col="red" )
hist(chain[-(1:burnIn),4],nclass=30, main="Posterior of sd", xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),4]) )
abline(v = trueSD, col="red" )
plot(chain[-(1:burnIn),1], type = "l", xlab="True value = red line" , main = expression(paste('Chain values of ', gamma[1])), )
abline(h = true1, col="red" )
plot(chain[-(1:burnIn),2], type = "l", xlab="True value = red line" , main = expression(paste('Chain values of ', gamma[2])), )
abline(h = true2, col="red" )
plot(chain[-(1:burnIn),3], type = "l", xlab="True value = red line" , main = expression(paste('Chain values of ', gamma[3])), )
abline(h = true3, col="red" )
plot(chain[-(1:burnIn),4], type = "l", xlab="True value = red line" , main = "Chain values of sd", )
summary(chain_mc)
chain_mc <- mcmc(chain)
summary(chain_mc)
rm(list = ls())
library("parallel")
library("tidyverse")
library("deSolve")
library("coda")
# True param:
gam1 = 0.025
gam2 = 0.14
gam3 = 0.48
true1 = gam1
true2 = gam2
true3 = gam3
trueSD = 1
# Easy plots:
output <- load("~/Documentos/PHD/2021/SUR_Model/OUTPUT/chain_IC_0_MH_2000eq_3param_25000_2021-09-29.RData")
burnIn = 5000
acceptance = 1-mean(duplicated(chain[-(1:burnIn),]))
par(mfrow = c(2,4))
hist(chain[-(1:burnIn),1],nclass=30, main = expression(paste('Posterior of ', gamma[1])), xlab="True value = red line" )
abline(v = mean(chain[-(1:burnIn),1]))
abline(v = true1, col="red" )
hist(chain[-(1:burnIn),2],nclass=30, main=expression(paste('Posterior of ', gamma[2])), xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),2]))
abline(v = true2, col="red" )
hist(chain[-(1:burnIn),3],nclass=30, main=expression(paste('Posterior of ', gamma[3])), xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),3]))#
par(mfrow = c(2,4))
hist(chain[-(1:burnIn),1],nclass=30, main = expression(paste('Posterior of ', gamma[1])), xlab="True value = red line" )
abline(v = mean(chain[-(1:burnIn),1]))
abline(v = true1, col="red" )
hist(chain[-(1:burnIn),2],nclass=30, main=expression(paste('Posterior of ', gamma[2])), xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),2]))
abline(v = true2, col="red" )
hist(chain[-(1:burnIn),3],nclass=30, main=expression(paste('Posterior of ', gamma[3])), xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),3]))#
abline(v = true3, col="red" )
hist(chain[-(1:burnIn),4],nclass=30, main="Posterior of sd", xlab="True value = red line")
abline(v = mean(chain[-(1:burnIn),4]) )
abline(v = trueSD, col="red" )
plot(chain[-(1:burnIn),1], type = "l", xlab="True value = red line" , main = expression(paste('Chain values of ', gamma[1])), )
abline(h = true1, col="red" )
plot(chain[-(1:burnIn),2], type = "l", xlab="True value = red line" , main = expression(paste('Chain values of ', gamma[2])), )
abline(h = true2, col="red" )
plot(chain[-(1:burnIn),3], type = "l", xlab="True value = red line" , main = expression(paste('Chain values of ', gamma[3])), )
abline(h = true3, col="red" )
plot(chain[-(1:burnIn),4], type = "l", xlab="True value = red line" , main = "Chain values of sd", )
abline(h = trueSD, col="red" )
chain_mc <- mcmc(chain)
df_rho$rho_H <- df_rho$rho*H
#-----------------------------------------------------------------------------#
###### Rho data #######:
# Simulation data for participation:
Path_rho <- "~/MAD_MODEL/SUR_MODEL/Code/rho_sim.rds"
df_rho <- readRDS(Path_rho)
ggplot(df_rho) +
geom_line(aes(x = date, y =rho)) +
ggtitle("Encounter rate computed from Citizen Science model") +
theme_bw() +
theme(text = element_text(size=14))
H = 1600000
H <- 1600000
df_rho$rho_H <- df_rho$rho*H
ggplot(df_rho) +
geom_line(aes(x = date, y =rho_H)) +
ggtitle("Encounter rate computed from Citizen Science model") +
theme_bw() +
theme(text = element_text(size=14))
View(df_rho)
View(df_rho)
